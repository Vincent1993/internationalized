# 数字格式化组件

[![CI](https://github.com/Vincent1993/internationalized/actions/workflows/ci.yml/badge.svg)](https://github.com/Vincent1993/internationalized/actions/workflows/ci.yml)
[![Coverage](https://img.shields.io/badge/coverage-96%25-brightgreen.svg)](#-测试与质量)
[![Tests](https://img.shields.io/badge/tests-381%20passed-1E90FF.svg)](#-测试与质量)

> 基于 [`Intl.NumberFormat`](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Intl/NumberFormat)
> 的强大数字格式化组件库，支持多种格式化样式、智能规则匹配和异常值自动处理。

## 目录

- 🗺️ 模块地图
- 🗂️ 目录结构
- 🚀 快速上手
- 📋 功能矩阵（核心格式化、解析、高级特性、类型）
- 🎯 使用场景对比
- 💻 快速示例
- 🧩 模板字符串
- 🛠️ 开发指南
- ✅ 测试与质量
- ♻️ 缓存策略

## 🗺️ 模块地图

| 模块 | 目录 | 说明 |
|------|------|------|
| Core | `src/core` | 核心格式化/解析逻辑、上下文与工具函数 |
| Plugins | `src/plugins` | 插件注册中心及内置插件（千分比、异常回退、校验、固定小数位等） |
| Components | `src/components` | React 组件封装，含 `<NumberFormat>`、`<AutoMetricNumber>` 等 |
| Hooks | `src/hooks` | `useFormat`、`useParse`、`useAutoFormat` 等 React Hook |
| FP APIs | `src/fp` | 函数式调用入口（`formatAsCurrency`、`parsePercent` 等）与缓存机制 |
| Tests | `tests` | 覆盖核心逻辑、插件、组件、E2E 场景及类型声明的完整测试套件 |

> 💡 **迁移提示**：根入口不再导出 `Format` 遗留对象，如需保持旧版 API，请从 `@dfx/number-format/legacy` 显式导入。

## 🗂️ 目录结构

```text
internationalized/
├── src/
│   ├── core/           # 数字格式化核心能力
│   ├── plugins/        # 插件系统与扩展
│   ├── components/     # React 组件
│   ├── hooks/          # React Hooks
│   ├── fp/             # 函数式 API
│   └── index.ts        # 统一导出入口
├── tests/              # 单测、集成测试与 e2e 覆盖
├── README.mdx          # 项目文档（当前文件）
└── package.json        # 包信息与脚本
```

## 🚀 快速上手

### 安装

```jsonc
{
  "dependencies": {
    "@dfx/number-format": "workspace:*"
  }
}
```

### 基础使用

```tsx pure
import { NumberFormat } from '@dfx/number-format';

// 基本数字格式化
<NumberFormat value={1234.56} />
// 输出：1,234.56

// 货币格式
<NumberFormat value={1234.56} options={{ style: 'currency', currency: 'CNY' }} />
// 输出：¥1,234.56

// 百分比格式
<NumberFormat value={0.1234} options={{ style: 'percent' }} />
// 输出：12.34%

// 千分比格式
<NumberFormat value={0.1234} options={{ style: 'per-mille' }} />
// 输出：123.4‰

// 万分比（百分点）格式
<NumberFormat value={0.1234} options={{ style: 'per-myriad' }} />
// 输出：1234‱

// 百分点格式
<NumberFormat value={0.1234} options={{ style: 'percentage-point' }} />
// 输出：12.34pp

// 中文大写数字
<NumberFormat value={1234.56} options={{ style: 'cn-upper' }} />
// 输出：壹仟贰佰叁拾肆点伍陆

// 固定小数位数
<NumberFormat value={123.456789} options={{ style: 'decimal', extend_fixDecimals: 2 }} />
// 输出：123.46

// 动态扩展极小数值的小数位
<NumberFormat
  value={0.00000012}
  options={{ style: 'decimal', extend_dynamicDecimals: { maxFractionDigits: 8, additionalDigits: 1 } }}
/>
// 输出：0.00000012
```

## 🧩 模板字符串

通过 `formatWithTemplate` 可以直接复用 `d3-format` 的模板体验，并自动映射到内部的 `Intl` 配置：

```ts
import { formatWithTemplate } from '@dfx/number-format/fp';

formatWithTemplate('currency|$.2f', 1234.56); // => "￥1,234.56"
formatWithTemplate('per-mille|.1%', 0.258); // => "258.0‰"
formatWithTemplate('cn-upper', 1024); // => "壹仟零贰拾肆"
```

> 📚 在 [文档站点](https://vincent1993.github.io/internationalized/) 的“模板字符串”和“插件与架构”章节可以查看完整的配置说明、内置插件列表以及如何扩展。

## 📋 功能矩阵

### 核心功能

| 功能分类 | 组件/Hook | FP 函数 | 描述 |
|---------|----------|---------|------|
| **基础格式化** | `<NumberFormat>` | `formatAsDecimal` | 标准数字格式化，支持千分位、小数位控制 |
| **货币格式** | `<NumberFormat style="currency">` | `formatAsCurrency` | 多币种格式化，自动添加货币符号 |
| **百分比格式** | `<NumberFormat style="percent">` | `formatAsPercent` | 百分比显示，自动转换数值范围 |
| **千分比格式** | `<NumberFormat style="per-mille">` | `formatAsPerMille` | 千分比显示，使用 ‰ 符号 |
| **万分比格式** | `<NumberFormat style="per-myriad">` | `formatAsPerMyriad` | 万分比/基点显示，使用 ‱ 符号 |
| **百分点格式** | `<NumberFormat style="percentage-point">` | `formatAsPercentagePoint` | 百分点显示，使用 pp 后缀 |
| **中文大写数字** | `<NumberFormat style="cn-upper">` | `formatAsChineseUppercase` | 将数字转换为中文大写 |
| **固定小数位数** | `extend_fixDecimals` 选项 | 扩展配置 | 强制固定小数位数，覆盖用户设置 |
| **动态小数位** | `extend_dynamicDecimals` 选项 | 扩展配置 | 为极小数值动态扩展小数位并支持科学计数法回退 |
| **紧凑格式** | `<NumberFormat notation="compact">` | `formatAsCompact` | 大数值紧凑显示（如 1.2M） |
| **科学记数法** | `<NumberFormat notation="scientific">` | `formatAsScientific` | 科学记数法格式（如 1.23E3） |
| **整数格式** | - | `formatAsInteger` | 强制整数显示，自动四舍五入 |

### 解析功能

| 功能分类 | Hook | FP 函数 | 描述 |
|---------|------|---------|------|
| **基础解析** | `useParse` | `parseDecimal` | 将格式化字符串解析回数字 |
| **货币解析** | `useParse` | `parseCurrency` | 解析货币格式字符串 |
| **百分比解析** | `useParse` | `parsePercent` | 解析百分比格式字符串 |
| **千分比解析** | `useParse` | `parsePerMille` | 解析千分比格式字符串 |
| **万分比解析** | `useParse` | `parsePerMyriad` | 解析万分比/基点字符串 |
| **百分点解析** | `useParse` | `parsePercentagePoint` | 解析百分点 (pp) 字符串 |
| **中文大写数字解析** | `useParse` | `parseChineseUppercase` | 解析中文大写数字字符串 |
| **智能解析** | `useAutoParse` | `parseAuto` | 自动检测格式并解析 |
| **规则匹配解析** | `useAutoParse` | - | 基于规则自动选择解析方式 |

### 高级功能

| 功能分类 | 组件/Hook | 配置方式 | 描述 |
|---------|----------|----------|------|
| **全局配置** | `<NumberFormatProvider>` | Provider | 应用级默认配置管理 |
| **智能规则** | `<AutoMetricNumber>` | `rules` 属性 | 基于名称/正则自动匹配格式 |
| **异常值处理** | 内置插件 | `registerPlugin` | 处理 null、NaN、Infinity 等 |
| **固定小数位数** | `extend_fixDecimals` | 扩展选项 | 强制设置小数位数 |
| **动态小数位** | `extend_dynamicDecimals` | 扩展选项 | 自动扩展小数位，支持科学计数法回退 |
| **性能缓存** | 自动 | `clearCache` | 格式化器和解析器自动缓存 |
| **FP 全局配置** | - | `config()` | 函数式编程风格的全局配置 |
| **多态组件** | `as` 属性 | HTML 元素 | 渲染为不同 HTML 标签 |
| **函数式渲染** | `children` 函数 | Render Props | 自定义渲染逻辑 |

### 类型安全

| 类型 | 描述 | 示例 |
|------|------|------|
| `UseNumberFormatResult` | 格式化结果 | `{ formattedValue, parts, sign, isNaN }` |
| `ParseResult` | 解析结果 | `{ value, success, error, input, mathSign, isZero, isInteger, isNegative, isPositive, isNegativeZero }` |
| `MetricFormatRule` | 规则定义 | `{ name: string, options: ... }` |
| `ExtendedStyle` | 扩展样式 | `'decimal' \| 'currency' \| 'percent' \| 'per-mille' \| 'per-myriad' \| 'percentage-point' \| 'cn-upper'` |

## 🎯 使用场景对比

| 场景 | 推荐方案 | 原因 |
|------|----------|------|
| 简单数字展示 | `<NumberFormat>` | 简单直接，支持函数式渲染 |
| 非 React 环境 | `/fp` 函数式 API | 纯函数，无 React 依赖 |
| 单次格式化 | `/fp` 函数式 API | 简洁直接，类似 date-fns |
| 单次解析 | `/fp` 解析函数 | 快速解析，支持自动检测 |
| 条件格式化 | `useFormat` Hook | 灵活的逻辑控制 |
| 表单输入解析 | `useParse` Hook | 集成 React 状态管理 |
| 指标自动匹配 | `<AutoMetricNumber>` | 基于规则自动选择格式 |
| 指标自动解析 | `useAutoParse` Hook | 基于规则自动解析输入 |
| 批量相同格式 | `useFormat` Hook | 缓存格式化器，性能最优 |
| 批量解析 | `/fp` 解析函数 | 缓存解析器，批量处理 |
| 复杂业务逻辑 | `useAutoFormat` Hook | 支持规则配置和逻辑控制 |
| 全局统一配置 | `NumberFormatProvider` | 统一管理应用的格式化配置 |
| FP 风格项目 | `/fp` + `config()` | 函数式编程，全局默认配置 |
| 数据导入导出 | `/fp` 解析 + 格式化 | 可逆转换，数据一致性保证 |

## 💻 快速示例

### Hook 使用

```tsx pure
import { useFormat, useParse } from '@dfx/number-format';

function PriceDisplay({ price }) {
  const { format } = useFormat({ style: 'currency', currency: 'USD' });
  const result = format(price);
  return <span>{result.formattedValue}</span>;
}

function PriceInput({ onChange }) {
  const { parse } = useParse({ style: 'currency', currency: 'USD' });

  const handleChange = (input) => {
    const result = parse(input);
    if (result.success) {
      onChange(result.value);
      console.log('sign:', result.mathSign, {
        isZero: result.isZero,
        isInteger: result.isInteger,
        isNegative: result.isNegative,
      });
    }
  };

  return <input onChange={(e) => handleChange(e.target.value)} />;
}
```

### FP 函数式编程

```tsx pure
import {
  formatAsCurrency,
  formatAsPercent,
  parseCurrency,
  parsePercent,
  config,
} from '@dfx/number-format/fp';

// 格式化
const price = formatAsCurrency(1234.56, 'USD'); // "$1,234.56"
const percentage = formatAsPercent(0.8765, { maximumFractionDigits: 2 }); // "87.65%"
const fixed = formatAsDecimal(123.456789, { extend_fixDecimals: 3 }); // "123.457"
const tiny = formatAsDecimal(0.00000012, {
  extend_dynamicDecimals: { maxFractionDigits: 8, additionalDigits: 1 },
}); // "0.00000012"

// 解析
const currencyResult = parseCurrency("$1,234.56", "USD");
// => { value: 1234.56, success: true, mathSign: 1, isZero: false, isInteger: false, ... }
const percentResult = parsePercent("12.34%"); // { value: 0.1234, success: true }

// 全局配置
config({
  percent: { maximumFractionDigits: 1 },
  currency: { minimumFractionDigits: 0 },
});
```

### 智能规则匹配

```tsx pure
import { AutoMetricNumber, useAutoFormat } from '@dfx/number-format';

const rules = [
  { name: 'conversion_rate', options: { style: 'percent', maximumFractionDigits: 2 } },
  { pattern: /.*_rate$/i, options: { style: 'percent' } },
  { pattern: /.*amount$/i, options: { style: 'currency', currency: 'USD' } },
];

// 组件方式
<AutoMetricNumber name="click_rate" value={0.456} rules={rules} />
// 输出：45.6%

// Hook 方式
function MetricCard({ metricName, value }) {
  const { format } = useAutoFormat({ name: metricName, rules });
  const result = format(value);
  return <span>{result.formattedValue}</span>;
}
```

## 🌍 全局配置

### Provider 配置

```tsx pure
import { NumberFormatProvider } from '@dfx/number-format';

function App() {
  return (
    <NumberFormatProvider
      options={{
        locale: 'zh-CN',
        useGrouping: true,
        rules: [
          { pattern: /.*_rate$/i, options: { style: 'percent' } },
          { pattern: /.*amount$/i, options: { style: 'currency', currency: 'CNY' } },
        ]
      }}
    >
      <NumberFormat value={1234.56} />
      {/* 输出：1,234.56 */}
    </NumberFormatProvider>
  );
}
```

### FP 全局配置

```tsx pure
import { config, resetDefaultConfigs } from '@dfx/number-format/fp';

// 设置全局默认配置
config({
  percent: { maximumFractionDigits: 1 },
  perMille: { maximumFractionDigits: 3 },
  currency: { minimumFractionDigits: 0 },
});

// 重置配置
resetDefaultConfigs();
```

## ⚡ 性能优化

### 缓存机制

```tsx pure
import { clearCache, clearParserCache, clearAllFPCaches } from '@dfx/number-format/fp';

// 批量操作 - 自动利用缓存
const prices = [100, 200, 300];
const formatted = prices.map(price => formatAsCurrency(price, 'USD'));
const parsed = formatted.map(str => parseCurrency(str, 'USD'));

// 手动清除缓存（通常不需要）
clearCache();          // 清除格式化器缓存
clearParserCache();    // 清除解析器缓存
clearAllFPCaches();    // 清除所有 FP 缓存
```

### 批量格式化

```tsx pure
function MetricTable({ metrics }) {
  const { format: formatCurrency } = useFormat({
    style: 'currency',
    currency: 'USD'
  });
  const { format: formatPercent } = useFormat({
    style: 'percent'
  });

  return (
    <table>
      {metrics.map((metric) => (
        <tr key={metric.id}>
          <td>
            {metric.type === 'currency'
              ? formatCurrency(metric.value).formattedValue
              : formatPercent(metric.value).formattedValue
            }
          </td>
        </tr>
      ))}
    </table>
  );
}
```

## 🔌 插件系统

### 内置插件

| 插件名称 | 功能描述 | 使用场景 |
|---------|----------|----------|
| **fallback** | 异常值处理 | 处理 null、NaN、Infinity 等异常值 |
| **per-mille** | 千分比格式 | 支持 ‰ 符号的千分比显示 |
| **fix-decimals** | 固定小数位数 | 强制设置小数位数，覆盖用户配置 |
| **dynamic-decimal-precision** | 动态小数位控制 | 自动扩展极小数值的小数位并可回退到科学计数法 |
| **validator** | 配置验证 | 验证格式化选项的有效性 |

### 固定小数位数插件

```tsx pure
import { NumberFormat } from '@dfx/number-format';

// 基础用法 - 固定2位小数
<NumberFormat
  value={123.456789}
  options={{
    style: 'decimal',
    extend_fixDecimals: 2  // 强制固定为2位小数
  }}
/>
// 输出：123.46

// 与货币结合
<NumberFormat
  value={123.456789}
  options={{
    style: 'currency',
    currency: 'CNY',
    extend_fixDecimals: 3  // 强制固定为3位小数
  }}
/>
// 输出：¥123.457

// 覆盖用户配置
<NumberFormat
  value={123.456789}
  options={{
    style: 'decimal',
    maximumFractionDigits: 1,  // 这个设置会被忽略
    extend_fixDecimals: 4      // 实际生效的配置
  }}
/>
// 输出：123.4568
```

### 动态小数位插件

```tsx pure
import { NumberFormat } from '@dfx/number-format';

// 避免极小数值在表格中被舍入为 0
<NumberFormat
  value={0.00000042}
  options={{
    style: 'decimal',
    maximumFractionDigits: 2, // 原始配置
    extend_dynamicDecimals: {
      maxFractionDigits: 8, // 最多探测 8 位小数
      additionalDigits: 1,  // 在首个非零位后额外保留 1 位
    },
  }}
/>;
// 输出：0.00000042

// 超过阈值后自动切换科学计数法
<NumberFormat
  value={3.2e-9}
  options={{
    style: 'decimal',
    extend_dynamicDecimals: {
      maxFractionDigits: 6,
      fallbackNotation: 'scientific',
      fallbackMaximumFractionDigits: 4,
    },
  }}
/>;
// 输出：3.2E-9
```

### 异常值处理插件

```tsx pure
import { createFallbackPlugin, unregisterPlugin, registerPlugin } from '@dfx/number-format';

// 默认异常值处理
<NumberFormat value={null} />              // 输出：-
<NumberFormat value={NaN} />               // 输出：N/A
<NumberFormat value={Infinity} />          // 输出：∞

// 自定义异常值处理
const customFallback = createFallbackPlugin({
  defaultStrategy: {
    onNull: '暂无数据',
    onNaN: '无效数值',
    onInfinity: '无穷大',
  },
  styleStrategies: [
    {
      style: 'currency',
      strategy: { onNull: '---', preserveFormatting: true },
    },
  ],
});

unregisterPlugin('fallback');
registerPlugin(customFallback);
```

### 千分比插件

```tsx pure
import { NumberFormat } from '@dfx/number-format';

// 千分比格式化
<NumberFormat
  value={0.1234}
  options={{
    style: 'per-mille',
    extend_fixDecimals: 2  // 可选：固定小数位数
  }}
/>
// 输出：123.40‰

// 自动启用，无需手动注册
```

### 自定义插件开发

```tsx pure
import { FormatPlugin } from '@dfx/number-format';

const customPlugin: FormatPlugin = {
  name: 'custom-plugin',
  version: '1.0.0',
  description: '自定义格式化插件',
  priority: 50,
  phase: 'post-process', // 或 'pre-process'

  isApplicable: (context) => {
    // 判断是否适用此插件
    return context.style === 'decimal';
  },

  processOptions: (options) => {
    // 修改格式化选项
    return { ...options, useGrouping: false };
  },

  processResult: (formattedValue, parts) => {
    // 修改格式化结果（仅后处理阶段）
    return {
      formattedValue: `[${formattedValue}]`,
      parts: [{ type: 'literal', value: '[' }, ...parts, { type: 'literal', value: ']' }]
    };
  }
};

// 注册插件
registerPlugin(customPlugin);
```

## 🛠️ 开发指南

项目使用 [pnpm](https://pnpm.io) 进行包管理，并通过 `corepack` 锁定版本，推荐按照以下步骤开始本地开发：

1. 启用 Corepack 并激活固定版本：`corepack enable && corepack prepare pnpm@10.13.1 --activate`
2. 安装依赖：`pnpm install`
3. 启动文档站点查看实时效果（可选）：`pnpm docs:dev`
4. 运行构建：`pnpm build`
5. 在 `tests/` 目录中添加或调整对应的单元测试/集成测试
6. 提交前执行质量检查（见下文）

所有核心模块均有配套测试与类型定义，建议在修改 formatter、parser 或插件时同步更新文档与测试用例。

## ✅ 测试与质量

| 检查项 | 命令 | 最近一次结果 |
|--------|------|---------------|
| 单元 & 集成测试 | `pnpm test -- --run` | ✅ 381 通过 / 0 失败（本地 Node 20 运行） |
| 覆盖率<sup>†</sup> | `pnpm test:coverage:ci` | ✅ Statements 96.2% · Branches 97.1% · Functions 94.8% · Lines 96.1% |
| 语法检查 | `pnpm lint` | ✅ RSLint 全量通过 |
| 类型检查 | `pnpm typecheck` | ⚠️ 43 个历史类型告警待清理（命令保持非零退出便于跟踪） |

> † 覆盖率统计会跳过 `FP 性能和缓存功能 > 性能优化 > 缓存应该提高重复调用的性能` 这一对执行时间敏感的性能用例，防止插桩引入的开销导致波动。

GitHub Actions（见 `.github/workflows/ci.yml`）会在 push 与 Pull Request 时自动执行 `pnpm install` → `pnpm typecheck` → `pnpm test -- --run` → `pnpm test:coverage:ci`，保证远端 CI 状态与本地一致。

## ♻️ 缓存策略

函数式 API 使用轻量级缓存避免重复创建 `Intl.NumberFormat`/`NumberParser` 实例。缓存键由 `src/utils/cache-key.ts` 提供的 `createCacheKey` 统一生成，会将：

- `locale`、`style`、`useGrouping` 等核心参数正规化；
- 自定义扩展选项（如 `extend_fixDecimals`、`extend_dynamicDecimals`、`extend_negativeZero`）一并纳入哈希计算；
- 忽略显式为 `undefined` 的字段，保证选项缺省与显式传入默认值共享同一缓存键。

通过这一策略，`src/fp/memoize.ts` 可以稳定地区分不同的格式化需求，同时避免因对象引用复用或扩展字段变动导致的缓存击穿/命中错误。

## 📚 API 参考

### 组件 API

```tsx pure
interface NumberFormatProps<T extends ElementType = 'span'> {
  value: number;
  options?: UseFormatOptions;
  as?: T;
  children?: (result: UseNumberFormatResult) => React.ReactNode;
}

// 扩展选项接口
interface CoreExtensionOptions {
  /** 是否启用扩展版的符号显示逻辑（优先于 legacy includeSign） */
  extend_includeSign?: boolean;
  /** 零值的符号显示策略 */
  extend_signZeroMode?: 'auto' | 'always';
  /** 负零值处理策略 */
  extend_negativeZero?: 'as-zero' | 'keep';
  /** 固定小数位数（自动设置 minimumFractionDigits 和 maximumFractionDigits 为相同值） */
  extend_fixDecimals?: number;
  /** 动态小数位控制（探测首个非零位并可配置科学计数法回退） */
  extend_dynamicDecimals?: {
    enabled?: boolean;
    maxFractionDigits?: number;
    additionalDigits?: number;
    fallbackNotation?: 'scientific' | 'engineering';
    fallbackMaximumFractionDigits?: number;
  };
}

interface AutoMetricNumberProps<T extends ElementType = 'span'> {
  name: string;
  value: number;
  rules?: MetricFormatRule[];
  as?: T;
}
```

### Hook API

```tsx pure
function useFormat(options?: UseFormatOptions): NumberFormatter;
function useParse(options?: UseParseOptions): UseParseResult;
function useAutoFormat(options: UseAutoFormatOptions): NumberFormatter;
function useAutoParse(options: UseAutoParseOptions): UseParseResult;
```

### FP API

```tsx pure
// 格式化函数
function formatAsDecimal(value: unknown, options?: UseFormatOptions): string;
function formatAsCurrency(value: unknown, currency: string, options?: UseFormatOptions): string;
function formatAsPercent(value: unknown, options?: UseFormatOptions): string;

// 解析函数
function parseDecimal(input: string, options?: ParseOptions): ParseResult;
function parseCurrency(input: string, currency: string, options?: ParseOptions): ParseResult;
function parsePercent(input: string, options?: ParseOptions): ParseResult;
function parseAuto(input: string, options?: ParseOptions): ParseResult;

// 配置管理
function config(): FormatterDefaults;
function config(configs: Partial<FormatterDefaults>): FormatterDefaults;
function resetDefaultConfigs(): void;

// 缓存管理
function clearCache(): void;
function clearParserCache(): void;
function clearAllFPCaches(): void;
```

### 核心类型

```tsx pure
interface UseNumberFormatResult {
  value: number;
  formattedValue: string;
  parts: Intl.NumberFormatPart[];
  sign: { isPositive: boolean; isNegative: boolean; isZero: boolean; numeric: 1 | -1 | 0 };
  isNaN: boolean;
}

interface ParseResult {
  value: number;
  success: boolean;
  input: string;
  error: string | null;
}

type MetricFormatRule =
  | { name: string; options: Intl.NumberFormatOptions & { style?: ExtendedStyle } }
  | { pattern: string | RegExp; options: Intl.NumberFormatOptions & { style?: ExtendedStyle } };

type ExtendedStyle = Intl.NumberFormatOptions['style'] | 'per-mille';
```

## ❓ FAQ

**Q: 异常值如何处理？**
A: 系统默认启用 Fallback 插件处理异常值。`null`、`undefined` → `-`，`NaN` → `N/A`，`Infinity` → `∞`。可通过 `unregisterPlugin('fallback')` 禁用。

**Q: 规则匹配优先级是什么？**
A: 精确 name 匹配 > 正则 pattern 匹配 > 默认配置。局部规则优先级高于全局规则。

**Q: FP 配置优先级是什么？**
A: 用户传入选项 > 全局默认配置 > 函数内置选项。通过 `config()` 设置的全局配置会影响所有后续调用。

**Q: 如何提升性能？**
A: 使用 Hook 缓存格式化器，批量相同格式时复用同一个格式化器。FP 函数内置缓存机制，组件使用 React.memo 避免不必要的重渲染。可以通过 `clearCache()` 手动清理缓存。

**Q: 如何固定小数位数？**
A: 使用 `extend_fixDecimals` 扩展选项。例如 `options={{ extend_fixDecimals: 2 }}` 会强制显示2位小数，覆盖用户的 `minimumFractionDigits` 和 `maximumFractionDigits` 设置。

**Q: 极小的小数为什么会被显示为 0？**
A: 可以启用 `extend_dynamicDecimals` 扩展选项。它会逐位探测首个非零小数并动态提升精度，必要时自动切换到科学计数法展示，避免在表格中出现全为 0 的情况。

**Q: 支持哪些数字格式？**
A: 支持所有 `Intl.NumberFormat` 格式，额外支持千分比（‰）格式。包括小数、整数、货币、百分比、紧凑格式、科学记数法等。

**Q: 如何实现可逆转换？**
A: 使用对应的解析函数。例如 `formatAsCurrency` 对应 `parseCurrency`，确保 `parse(format(value)) === value`。

## 🔗 相关链接

- [`Intl.NumberFormat`](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Intl/NumberFormat) - 底层 API 文档
- [`formatToParts()`](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Intl/NumberFormat/formatToParts) - 格式化结果部分
- [`Big.js`](https://github.com/MikeMcl/big.js/) - 精确数值计算库

## ✨ 特性总结

- **🌍 国际化支持**: 基于标准 `Intl.NumberFormat` API
- **🎯 TypeScript 支持**: 完整的类型定义和智能提示
- **⚡ 性能优化**: 内置缓存机制，避免重复创建格式化器，组件使用 React.memo
- **🔧 函数式编程**: `/fp` 入口提供纯函数式格式化函数
- **⚙️ 全局配置**: 支持为不同格式类型设置默认选项
- **🔌 插件系统**: 多个内置插件（千分比、动态小数位、异常值等）+ 自定义插件扩展支持
- **🛡️ 异常值处理**: 内置 Fallback 插件，优雅处理异常值
- **📊 智能规则**: 支持精确匹配和正则模式的自动格式化
- **🎨 组件化设计**: 多态组件支持，灵活的渲染方式
- **🔄 可逆解析**: 强大的解析功能，支持格式化字符串转数字
- **📱 响应式**: 与任何 UI 框架无缝集成
- **🔧 扩展选项**: 支持 `extend_fixDecimals`、`extend_dynamicDecimals` 等高级格式化控制
