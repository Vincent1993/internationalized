# FP 函数参考

函数式 API 将组件与 Hook 的能力抽象为纯函数，便于在 Node.js、服务端渲染或批处理脚本中直接使用。Monorepo 中提供两套入口：

- `@internationalized/number-format/fp`：面向数字的格式化、解析与模板工具。【F:packages/number-format/src/fp/index.ts†L1-L64】
- `@internationalized/date-format/fp`：面向日期时间的格式化、区间处理与默认配置管理。【F:packages/date-format/src/fp/index.ts†L1-L34】

## 数字格式化 API (`@internationalized/number-format/fp`)

### 入口与默认配置

所有函数共享同一套默认配置与缓存策略，可通过 `config()` 读取或更新，并使用 `resetDefaultConfigs()` 复原初始值。【F:packages/number-format/src/fp/defaults.ts†L6-L207】

格式化器与解析器均会被缓存，避免重复创建 `Intl.NumberFormat` 或自定义 `NumberParser` 的开销，可通过 `clearFormatterCache`、`clearParserCache` 等方法清理。【F:packages/number-format/src/fp/memoize.ts†L36-L140】

### 格式化函数

格式化函数分为返回字符串的基础版本与返回 `UseFormatResult` 的 `Ex` 版本，内部使用 `mergeOptionsWithDefaults` 合并默认配置、用户参数与强制项，再复用缓存的核心格式化器。【F:packages/number-format/src/fp/formatters.ts†L5-L37】【F:packages/number-format/src/fp/formatters.ts†L44-L240】【F:packages/number-format/src/fp/defaults.ts†L209-L229】

| 函数 | 描述 | 默认强制项 |
|------|------|------------|
| `formatAsDecimal` / `formatAsDecimalEx` | 十进制小数 | `style: 'decimal'` |
| `formatAsInteger` / `formatAsIntegerEx` | 四舍五入为整数并禁用小数位 | `style: 'decimal'`, `extend_fixDecimals: 0` |
| `formatAsCurrency` / `formatAsCurrencyEx` | 输出带货币符号的值 | `style: 'currency'`, `currency`（必填） |
| `formatAsPercent` / `formatAsPercentEx` | 百分比展示（内部倍率为 100） | `style: 'percent'` |
| `formatAsPerMille` / `formatAsPerMilleEx` | 千分比（‰） | `style: 'per-mille'` |
| `formatAsPerMyriad` / `formatAsPerMyriadEx` | 万分比（‱） | `style: 'per-myriad'` |
| `formatAsPercentagePoint` / `formatAsPercentagePointEx` | 百分点（pp） | `style: 'percentage-point'` |
| `formatAsChineseUppercase` / `formatAsChineseUppercaseEx` | 中文大写数字 | `style: 'cn-upper'` |
| `formatAsCompact` / `formatAsCompactEx` | 紧凑记数法（1.2M、1.2万） | `style: 'decimal'`, `notation: 'compact'` |
| `formatAsScientific` / `formatAsScientificEx` | 科学记数法 | `style: 'decimal'`, `notation: 'scientific'` |

> 所有函数都支持 `extend_*` 扩展选项，例如 `extend_dynamicDecimals`、`extend_includeSign` 等，用于激活对应插件。【F:packages/number-format/src/plugins/types.ts†L218-L226】【F:packages/number-format/src/plugins/dynamic-decimals/index.ts†L94-L182】

### 模板格式化

`formatWithTemplate` / `formatWithTemplateEx` 支持使用 `token|specifier` 描述格式化规则，并自动映射到上述函数的默认配置，适合批量定义展示模板。【F:packages/number-format/src/fp/templates.ts†L246-L357】

### 解析函数

解析 API 与格式化函数一一对应，同样分为基础版本与自动检测 `parseAuto`，最终都复用同一个 `NumberParser` 实例。【F:packages/number-format/src/fp/parsers.ts†L6-L234】【F:packages/number-format/src/fp/memoize.ts†L92-L140】

### 使用示例

```ts twoslash
import { config, formatAsCurrency, parseDecimal } from '@internationalized/number-format/fp';

// 读取当前默认配置
const defaults = config();

// 全局更新货币默认符号与精度
config({
  currency: { currency: 'USD', minimumFractionDigits: 2, maximumFractionDigits: 2 },
});

formatAsCurrency(1234.5, 'USD');
//=> "$1,234.50"

parseDecimal('1,234.50');
//=> { value: 1234.5 }
```

## 日期时间格式化 API (`@internationalized/date-format/fp`)

### 入口与缓存

日期函数式入口提供与 React 组件同源的格式化能力，并针对常用场景内置默认配置，可通过 `config()` 与 `resetDefaultConfigs()` 管理。【F:packages/date-format/src/fp/defaults.ts†L6-L137】

内部同样维护格式化器缓存，避免重复创建 `Intl.DateTimeFormat` 实例，并在首次写入时进行预热调用。【F:packages/date-format/src/fp/memoize.ts†L6-L75】

### 格式化函数

日期格式化函数遵循“基础版返回字符串、`Ex` 版返回 `UseDateFormatResult`”的模式，可选地复用 `date-fns` 的 `startOfDay`、`endOfDay` 等工具处理输入，再交给缓存的格式化器。【F:packages/date-format/src/fp/formatters.ts†L1-L136】【F:packages/date-format/src/fp/formatters.ts†L251-L328】【F:packages/date-format/src/utils/date.ts†L22-L60】

| 函数 | 描述 | 说明 |
|------|------|------|
| `formatAsDate` / `formatAsDateEx` | 以 `dateStyle: 'short'` 输出日期 | 默认语言 `zh-CN`，可通过 `options.locale` 覆盖。【F:packages/date-format/src/fp/formatters.ts†L138-L150】 |
| `formatAsTime` / `formatAsTimeEx` | 输出时间部分 | 使用 `timeStyle: 'short'`，支持覆盖时区。【F:packages/date-format/src/fp/formatters.ts†L152-L164】 |
| `formatAsDateTime` / `formatAsDateTimeEx` | 日期 + 时间 | 适合日程类场景。【F:packages/date-format/src/fp/formatters.ts†L166-L184】 |
| `formatAsDateTimeWithSeconds` / `formatAsDateTimeWithSecondsEx` | 含秒数的日期时间 | 使用 `timeStyle: 'medium'`。【F:packages/date-format/src/fp/formatters.ts†L186-L204】 |
| `formatAsWeekday` / `formatAsWeekdayEx` | 输出星期文本 | 默认 `weekday: 'long'`。【F:packages/date-format/src/fp/formatters.ts†L206-L218】 |
| `formatAsMonthDay` / `formatAsMonthDayEx` | 输出“X月X日” | 默认 `month: 'long'`。【F:packages/date-format/src/fp/formatters.ts†L220-L234】 |
| `formatAsMonth` / `formatAsMonthEx` | 输出月份名称 | 便于统计或报表。【F:packages/date-format/src/fp/formatters.ts†L237-L248】 |
| `formatAsStartOfDay` / `formatAsStartOfDayEx` | 将时间归一到日初再格式化 | 复用 `date-fns/startOfDay`。【F:packages/date-format/src/fp/formatters.ts†L251-L281】 |
| `formatAsEndOfDay` / `formatAsEndOfDayEx` | 将时间归一到日末再格式化 | 复用 `date-fns/endOfDay`。【F:packages/date-format/src/fp/formatters.ts†L283-L313】 |
| `formatDateRange` / `formatDateRangeEx` | 日期区间 | 自动排序区间两端，优先使用 `Intl.DateTimeFormat#formatRange`，回退到拼接字符串。【F:packages/date-format/src/fp/formatters.ts†L315-L328】 |

### 默认配置与示例

```ts twoslash
import { config, formatAsDate, formatDateRange } from '@internationalized/date-format/fp';

// 查看当前默认配置
const defaults = config();

// 将默认时区设置为上海
config({
  dateTime: { timeZone: 'Asia/Shanghai' },
});

formatAsDate('2024-05-20T08:30:00Z');
//=> "2024/5/20"

formatDateRange('2024-05-20', '2024-05-22', { timeZone: 'UTC' });
//=> "2024/5/20 – 2024/5/22"
```

> 使用 `clearFormatterCache()` 可以在测试或多租户环境中重置缓存，确保不同请求之间的隔离。【F:packages/date-format/src/fp/memoize.ts†L63-L108】
